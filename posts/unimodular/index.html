<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/tachyons.css"> <link rel=icon  href="/assets/favicon.png"> <link rel=preconnect  href="https://fonts.gstatic.com"> <link href="https://fonts.googleapis.com/css2?family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel=stylesheet > <title>Unimodular Matrices and Loops</title> <style> body { font-size: 16px; background: #f1f1f1; line-height: 1.8; font-family: "PT Serif", sans-serif; margin: 0 auto 0 auto; } a { color: #333; border-bottom: 3px solid #e1e1e1; text-decoration: none; transition: opacity .15s ease-in; } a:hover,a:focus { color: #000; border-bottom: 3px solid #c1c1c1; transition: opacity .15s ease-in; } .colbox-blue { background-color: #eef3f5; padding-top: 5px; padding-right: 10px; padding-left: 10px; padding-bottom: 5px; margin-left: 5px; margin-top: 5px; margin-bottom: 5px; border-radius: 0 10px 10px 0; border-left: 5px solid #4c9cf1; } blockquote { background: var(--block-background); border-left: 7px solid #a8a8a8; margin: 1.5em 10px; padding: 0.5em 10px; font-style: italic; } blockquote p { display: inline; } .hljs { font-family: "Fira Code", monospace; font-size: 14px; line-height: 1.35em; border-radius: 2px; } </style> <div class="pa5 pt4 pb4" style="margin: 0 auto; max-width: 900px; background: #ffffff"> <header> <div class="f2 lh-copy b"><a href="/" class="bn dim normal gray">Loop Compiler</a></div> <nav> <ul class="flex list pl0 bt bb b--moon-gray mb4"> <li class="pa2 pl0"><a class="bn dim" href="/">Home</a> </ul> </nav> </header> <h1 class="f2 lh-title normal dark-gray">Unimodular Matrices and Loops</h1> <div class="f5 lh-copy i gray">2022-03-02</div> <div class=franklin-content > <p>A unimodular matrix is a square integer matrix with determinate <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>±</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\pm 1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.72777em;vertical-align:-0.08333em;"></span><span class=mord >±</span><span class=mord >1</span></span></span></span>. With some basic linear algebra facts, we can show that a square integer matrix is unimodular if and only if its inverse exists and the inverse matrix is also an integer matrix.</p> <p>Let <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> be an unimodular matrix. As the determinate of an integer matrix must also be an integer, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >adj</mi><mo>⁡</mo><mo stretchy=false >(</mo><mi>A</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">\operatorname{adj}(A)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop ><span class="mord mathrm">a</span><span class="mord mathrm">d</span><span class="mord mathrm">j</span></span><span class=mopen >(</span><span class="mord mathnormal">A</span><span class=mclose >)</span></span></span></span> is also an integer matrix. It follows that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>A</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>=</mo><mfrac><mn>1</mn><mrow><mi>det</mi><mo>⁡</mo><mi>A</mi></mrow></mfrac><mi mathvariant=normal >adj</mi><mo>⁡</mo><mo stretchy=false >(</mo><mi>A</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">A^{-1} = \frac{1}{\det{A}} \operatorname{adj}(A)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8141079999999999em;vertical-align:0em;"></span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.190108em;vertical-align:-0.345em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class=pstrut  style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class=mtight >d</span><span class=mtight >e</span><span class=mtight >t</span></span><span class="mspace mtight" style="margin-right:0.19516666666666668em;"></span><span class="mord mtight"><span class="mord mathnormal mtight">A</span></span></span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class=pstrut  style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mop ><span class="mord mathrm">a</span><span class="mord mathrm">d</span><span class="mord mathrm">j</span></span><span class=mopen >(</span><span class="mord mathnormal">A</span><span class=mclose >)</span></span></span></span> is an integer matrix.</p> <p>To show the converse, let <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> be an integer square matrix such that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>A</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">A^{-1}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8141079999999999em;vertical-align:0em;"></span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span> is an integer matrix as well. Since <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>det</mi><mo>⁡</mo><mo stretchy=false >(</mo><mi>A</mi><mo stretchy=false >)</mo><mi>det</mi><mo>⁡</mo><mo stretchy=false >(</mo><msup><mi>A</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy=false >)</mo><mo>=</mo><mi>det</mi><mo>⁡</mo><mo stretchy=false >(</mo><mi>A</mi><msup><mi>A</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy=false >)</mo><mo>=</mo><mi>det</mi><mo>⁡</mo><mo stretchy=false >(</mo><mi>I</mi><mo stretchy=false >)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\det(A) \det(A^{-1}) = \det(A A^{-1}) = \det(I) = 1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.064108em;vertical-align:-0.25em;"></span><span class=mop >det</span><span class=mopen >(</span><span class="mord mathnormal">A</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mop >det</span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.064108em;vertical-align:-0.25em;"></span><span class=mop >det</span><span class=mopen >(</span><span class="mord mathnormal">A</span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop >det</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >1</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>det</mi><mo>⁡</mo><mo stretchy=false >(</mo><mi>A</mi><mo stretchy=false >)</mo><mo separator=true >,</mo><mi>det</mi><mo>⁡</mo><mo stretchy=false >(</mo><msup><mi>A</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy=false >)</mo><mo>∈</mo><mi mathvariant=double-struck >Z</mi></mrow><annotation encoding="application/x-tex">\det(A), \det(A^{-1}) \in \mathbb Z</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.064108em;vertical-align:-0.25em;"></span><span class=mop >det</span><span class=mopen >(</span><span class="mord mathnormal">A</span><span class=mclose >)</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mop >det</span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.68889em;vertical-align:0em;"></span><span class="mord mathbb">Z</span></span></span></span>, we can conclude that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>A</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">A^{-1}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8141079999999999em;vertical-align:0em;"></span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span> are unimodular.</p> <p>Say we have code like the following:</p> <pre><code class="julia-repl hljs"><span class=hljs-meta >julia&gt;</span><span class=language-julia > <span class=hljs-keyword >using</span> OffsetArrays
</span>
<span class=hljs-meta >julia&gt;</span><span class=language-julia > <span class=hljs-keyword >function</span> badmul2!(C,A,B)
           M,N = size(C)
           K = size(B,<span class=hljs-number >1</span>); fill!(C,<span class=hljs-number >0</span>)
           <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:M+N+K-<span class=hljs-number >3</span>, l <span class=hljs-keyword >in</span> max(<span class=hljs-number >0</span>,i+<span class=hljs-number >1</span>-N):min(M+K-<span class=hljs-number >2</span>,i), j <span class=hljs-keyword >in</span> max(<span class=hljs-number >0</span>,l+<span class=hljs-number >1</span>-K):min(M-<span class=hljs-number >1</span>,l)
               C[j,i-l] += A[j,l-j]*B[l-j,i-l]
           <span class=hljs-keyword >end</span>
           C
       <span class=hljs-keyword >end</span>
</span>badmul2! (generic function with 1 method)

<span class=hljs-meta >julia&gt;</span><span class=language-julia > M,K,N = <span class=hljs-number >5</span>,<span class=hljs-number >6</span>,<span class=hljs-number >7</span>
</span>(5, 6, 7)

<span class=hljs-meta >julia&gt;</span><span class=language-julia > A = OffsetArray(rand(M,K),-<span class=hljs-number >1</span>,-<span class=hljs-number >1</span>);
</span>
<span class=hljs-meta >julia&gt;</span><span class=language-julia > B = OffsetArray(rand(K,N),-<span class=hljs-number >1</span>,-<span class=hljs-number >1</span>);
</span>
<span class=hljs-meta >julia&gt;</span><span class=language-julia > C = OffsetArray(rand(M,N),-<span class=hljs-number >1</span>,-<span class=hljs-number >1</span>);
</span>
<span class=hljs-meta >julia&gt;</span><span class=language-julia > badmul2!(C,A,B)
</span>5×7 OffsetArray(::Matrix{Float64}, 0:4, 0:6) with eltype Float64 with indices 0:4×0:6:
 1.9536   1.20026   2.20549  1.11528   1.77055  2.14641  1.75909
 1.54733  1.10697   1.6769   1.13867   1.06312  1.71708  1.65325
 1.76249  0.908232  1.63373  0.995246  1.19762  1.69865  1.71706
 1.46832  0.939424  1.78488  1.36437   1.09265  1.69105  1.35382
 1.27257  0.770909  1.14775  0.596495  0.92855  1.21593  1.26251

<span class=hljs-meta >julia&gt;</span><span class=language-julia > parent(A)*parent(B)
</span>5×7 Matrix{Float64}:
 1.9536   1.20026   2.20549  1.11528   1.77055  2.14641  1.75909
 1.54733  1.10697   1.6769   1.13867   1.06312  1.71708  1.65325
 1.76249  0.908232  1.63373  0.995246  1.19762  1.69865  1.71706
 1.46832  0.939424  1.78488  1.36437   1.09265  1.69105  1.35382
 1.27257  0.770909  1.14775  0.596495  0.92855  1.21593  1.26251</code></pre> <p>Let <code>L</code> be the vector of loop ind vars, so <code>L &#61; &#91;i, l, j&#93;</code>, and <code>I_&#123;X&#125;</code> be the set of indices for array <code>&#123;X&#125;</code>. Then let <code>I_&#123;X&#125; &#61; A_&#123;X&#125; * L</code></p> <pre><code class="julia-repl hljs"><span class=hljs-meta >julia&gt;</span><span class=language-julia > A_A = [ <span class=hljs-number >0</span>  <span class=hljs-number >0</span>  <span class=hljs-number >1</span>;
               <span class=hljs-number >0</span>  <span class=hljs-number >1</span> -<span class=hljs-number >1</span>];
</span>
<span class=hljs-meta >julia&gt;</span><span class=language-julia > A_B = [ <span class=hljs-number >0</span>  <span class=hljs-number >1</span> -<span class=hljs-number >1</span>;
               <span class=hljs-number >1</span> -<span class=hljs-number >1</span>  <span class=hljs-number >0</span>];
</span>
<span class=hljs-meta >julia&gt;</span><span class=language-julia > A_C = [ <span class=hljs-number >0</span>  <span class=hljs-number >0</span>  <span class=hljs-number >1</span>;
               <span class=hljs-number >1</span> -<span class=hljs-number >1</span>  <span class=hljs-number >0</span>];</span></code></pre> <p>What we want is that each row has only a single non-zero element. Something something basis.</p> <pre><code class="julia-repl hljs"><span class=hljs-meta >julia&gt;</span><span class=language-julia > U = reduce(hcat, unique(Iterators.flatten(Iterators.map(eachrow, (A_A, A_B, A_C)))))&#x27;
</span>3×3 adjoint(::Matrix{Int64}) with eltype Int64:
 0   0   1
 0   1  -1
 1  -1   0
 
<span class=hljs-meta >julia&gt;</span><span class=language-julia > lu(<span class=hljs-built_in >Rational</span>.(U))
</span>LU{Rational{Int64}, Matrix{Rational{Int64}}, Vector{Int64}}
L factor:
3×3 Matrix{Rational{Int64}}:
 1//1  0//1  0//1
 0//1  1//1  0//1
 0//1  0//1  1//1
U factor:
3×3 Matrix{Rational{Int64}}:
 1//1  -1//1   0//1
 0//1   1//1  -1//1
 0//1   0//1   1//1

<span class=hljs-meta >julia&gt;</span><span class=language-julia > inv(ans)
</span>3×3 Matrix{Rational{Int64}}:
 1//1  1//1  1//1
 1//1  1//1  0//1
 1//1  0//1  0//1</code></pre> <p>We have <code>L &#61; A_&#123;X&#125; \ I_&#123;X&#125;</code>, but <code>A_&#123;X&#125;</code> is of course not necessarily square. Let <code>U*L &#61; O</code> so that <code>L &#61; U^&#123;-1&#125;*O</code> What we really want to do is transform the loops. Loop bounds are</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.24999999999999992em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mtext mathvariant=bold >W</mtext><mo>∗</mo><mtext mathvariant=bold >L</mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>≤</mo><mtext mathvariant=bold >B</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mo stretchy=false >(</mo><mtext mathvariant=bold >W</mtext><mo>∗</mo><msup><mtext mathvariant=bold >U</mtext><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy=false >)</mo><mo>∗</mo><mtext mathvariant=bold >O</mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>≤</mo><mtext mathvariant=bold >B</mtext></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} \textbf{W}*\textbf{L} &amp;\le \textbf{B}\\ (\textbf{W}*\textbf{U}^{-1})*\textbf{O} &amp;\le \textbf{B} \end{aligned}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:3.0501180000000003em;vertical-align:-1.2750590000000002em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.7750590000000002em;"><span style="top:-3.935059em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord text"><span class="mord textbf">W</span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >∗</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord text"><span class="mord textbf">L</span></span></span></span><span style="top:-2.384941em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mopen >(</span><span class="mord text"><span class="mord textbf">W</span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >∗</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class="mord text"><span class="mord textbf">U</span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.890118em;"><span style="top:-3.13901em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >∗</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord text"><span class="mord textbf">O</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.2750590000000002em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.7750590000000002em;"><span style="top:-3.935059em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class="mord textbf">B</span></span></span></span><span style="top:-2.384941em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class="mord textbf">B</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.2750590000000002em;"><span></span></span></span></span></span></span></span></span></span></span></span> <p>In our example, we have</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.24999999999999992em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>≤</mo><mi>i</mi><mo>≤</mo><mi>M</mi><mo>+</mo><mi>N</mi><mo>+</mo><mi>K</mi><mo>−</mo><mn>3</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>≤</mo><mi>l</mi><mo>≤</mo><mi>M</mi><mo>+</mo><mi>K</mi><mo>−</mo><mn>2</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mi>i</mi><mo>−</mo><mo stretchy=false >(</mo><mi>N</mi><mo>−</mo><mn>1</mn><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>≤</mo><mi>l</mi><mo>≤</mo><mi>i</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>≤</mo><mi>j</mi><mo>≤</mo><mi>M</mi><mo>−</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mi>l</mi><mo>−</mo><mo stretchy=false >(</mo><mi>K</mi><mo>−</mo><mn>1</mn><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>≤</mo><mi>j</mi><mo>≤</mo><mi>l</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} 0 &amp;\le i \le M+N+K-3\\ 0 &amp;\le l \le M+K-2\\ i-(N-1) &amp;\le l \le i\\ 0 &amp;\le j \le M-1\\ l-(K-1) &amp;\le j \le l \end{aligned}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:7.500000000000002em;vertical-align:-3.5000000000000018em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:4em;"><span style="top:-6.16em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >0</span></span></span><span style="top:-4.659999999999999em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >0</span></span></span><span style="top:-3.1599999999999984em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">i</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord >1</span><span class=mclose >)</span></span></span><span style="top:-1.6599999999999984em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >0</span></span></span><span style="top:-0.15999999999999837em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord >1</span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:3.5000000000000018em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:4em;"><span style="top:-6.16em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">i</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord >3</span></span></span><span style="top:-4.659999999999999em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord >2</span></span></span><span style="top:-3.1599999999999984em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">i</span></span></span><span style="top:-1.6599999999999984em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord >1</span></span></span><span style="top:-0.15999999999999837em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:3.5000000000000018em;"><span></span></span></span></span></span></span></span></span></span></span></span> <pre><code class="julia-repl hljs"><span class=hljs-meta >julia&gt;</span><span class=language-julia > W = [ <span class=hljs-number >1</span>  <span class=hljs-number >0</span>  <span class=hljs-number >0</span>    <span class=hljs-comment >#  [ i       [ M+N+K-3</span>
            -<span class=hljs-number >1</span>  <span class=hljs-number >0</span>  <span class=hljs-number >0</span>    <span class=hljs-comment >#    l    &lt;=   0</span>
             <span class=hljs-number >0</span>  <span class=hljs-number >1</span>  <span class=hljs-number >0</span>    <span class=hljs-comment >#    j ]       M+K-2</span>
             <span class=hljs-number >0</span> -<span class=hljs-number >1</span>  <span class=hljs-number >0</span>    <span class=hljs-comment >#              0</span>
             <span class=hljs-number >1</span> -<span class=hljs-number >1</span>  <span class=hljs-number >0</span>    <span class=hljs-comment >#              N-1</span>
            -<span class=hljs-number >1</span>  <span class=hljs-number >1</span>  <span class=hljs-number >0</span>    <span class=hljs-comment >#              0</span>
             <span class=hljs-number >0</span>  <span class=hljs-number >0</span>  <span class=hljs-number >1</span>    <span class=hljs-comment >#              M-1</span>
             <span class=hljs-number >0</span>  <span class=hljs-number >0</span> -<span class=hljs-number >1</span>    <span class=hljs-comment >#              0</span>
             <span class=hljs-number >0</span>  <span class=hljs-number >1</span> -<span class=hljs-number >1</span>    <span class=hljs-comment >#              K-1</span>
             <span class=hljs-number >0</span> -<span class=hljs-number >1</span>  <span class=hljs-number >1</span> ]  <span class=hljs-comment >#              0      ]</span>
</span>
<span class=hljs-meta >julia&gt;</span><span class=language-julia > WAi = <span class=hljs-built_in >Int</span>.(W / lu(<span class=hljs-built_in >Rational</span>.(U)))
</span>10×3 Matrix{Int64}: # let O = [x, y, z]
  1   1   1  #  [ x       [ M+N+K-3
 -1  -1  -1  #    y    &lt;=   0
  1   1   0  #    z ]       M+K-2
 -1  -1   0  #              0
  0   0   1  #              N-1
  0   0  -1  #              0
  1   0   0  #              M-1
 -1   0   0  #              0
  0   1   0  #              K-1
  0  -1   0  #              0      ]</code></pre> <p>So this tells us:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.24999999999999992em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>≤</mo><mi>z</mi><mo>≤</mo><mi>N</mi><mo>−</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>≤</mo><mi>x</mi><mo>≤</mo><mi>M</mi><mo>−</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>≤</mo><mi>y</mi><mo>≤</mo><mi>K</mi><mo>−</mo><mn>1</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} 0 &amp;\le z \le N-1\\ 0 &amp;\le x \le M-1\\ 0 &amp;\le y \le K-1 \end{aligned}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:4.500000000000002em;vertical-align:-2.000000000000001em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >0</span></span></span><span style="top:-3.16em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >0</span></span></span><span style="top:-1.6599999999999993em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >0</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2.000000000000001em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord >1</span></span></span><span style="top:-3.16em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord >1</span></span></span><span style="top:-1.6599999999999993em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≤</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord >1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2.000000000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span> <p>Now, what happens if we have loops more like</p> <pre><code class="julia hljs"><span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:I-<span class=hljs-number >1</span>, j <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:J-<span class=hljs-number >1</span>, k <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:K-<span class=hljs-number >1</span>, l <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:L-<span class=hljs-number >1</span>
    C[i,j] += A[i+k,j+l]*B[k,l]
<span class=hljs-keyword >end</span></code></pre> <p>more interesting, then... Lets say someone runs reverse diff on this With respect to the kernel:</p> <pre><code class="julia hljs"><span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:I-<span class=hljs-number >1</span>, j <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:J-<span class=hljs-number >1</span>, k <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:K-<span class=hljs-number >1</span>, l <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:L-<span class=hljs-number >1</span>
    Bbar[k,l] += A[i+k,j+l]*Cbar[i,j]
<span class=hljs-keyword >end</span></code></pre> <p>This is nice and easy to optimize. Let&#39;s move on. With respect to whatever was being convolved with the kernel:</p> <pre><code class="julia hljs"><span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:I-<span class=hljs-number >1</span>, j <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:J-<span class=hljs-number >1</span>, k <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:K-<span class=hljs-number >1</span>, l <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:L-<span class=hljs-number >1</span>
    Abar[i+k,j+l] += Cbar[i,j]*B[k,l]
<span class=hljs-keyword >end</span></code></pre> <p>&#40;You may need this if you have a convolution like this that isn&#39;t the first layer of a conv net, as it must backprop Abar to the preceding layer&#41; Let&#39;s try and get it so we can actually hoist <code>Abar</code> out of a few loops and tile.</p> <pre><code class="julia hljs">A_Abar = [<span class=hljs-number >1</span> <span class=hljs-number >0</span> <span class=hljs-number >1</span> <span class=hljs-number >0</span>;
          <span class=hljs-number >0</span> <span class=hljs-number >1</span> <span class=hljs-number >0</span> <span class=hljs-number >1</span>];

A_Cbar = [<span class=hljs-number >1</span> <span class=hljs-number >0</span> <span class=hljs-number >0</span> <span class=hljs-number >0</span>;
          <span class=hljs-number >0</span> <span class=hljs-number >1</span> <span class=hljs-number >0</span> <span class=hljs-number >0</span>];

A_B    = [<span class=hljs-number >0</span> <span class=hljs-number >0</span> <span class=hljs-number >1</span> <span class=hljs-number >0</span>;
          <span class=hljs-number >0</span> <span class=hljs-number >0</span> <span class=hljs-number >0</span> <span class=hljs-number >1</span>];</code></pre> <pre><code class="julia hljs"><span class=hljs-keyword >for</span> ik <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:I+K-<span class=hljs-number >2</span>, jl <span class=hljs-keyword >in</span> <span class=hljs-number >0</span>:J+L-<span class=hljs-number >2</span>, k <span class=hljs-keyword >in</span> max(<span class=hljs-number >0</span>,ik-(I+K-<span class=hljs-number >2</span>)):min(K-<span class=hljs-number >1</span>,ik), l <span class=hljs-keyword >in</span> max(<span class=hljs-number >0</span>,jl-(J+L-<span class=hljs-number >2</span>)):min(L-<span class=hljs-number >1</span>,jl)
    Abar[ik, jl] += Cbar[ik-k,jl-l]*B[k,l]
<span class=hljs-keyword >end</span>
U = [ <span class=hljs-number >1</span> <span class=hljs-number >0</span> <span class=hljs-number >1</span> <span class=hljs-number >0</span>    <span class=hljs-comment ># [ i   = [ ik</span>
      <span class=hljs-number >0</span> <span class=hljs-number >1</span> <span class=hljs-number >0</span> <span class=hljs-number >1</span>    <span class=hljs-comment >#   j       jl</span>
      <span class=hljs-number >0</span> <span class=hljs-number >0</span> <span class=hljs-number >1</span> <span class=hljs-number >0</span>    <span class=hljs-comment >#   k       k</span>
      <span class=hljs-number >0</span> <span class=hljs-number >0</span> <span class=hljs-number >0</span> <span class=hljs-number >1</span> ]  <span class=hljs-comment >#   l ]     l ]</span>
<span class=hljs-comment ># L = [i, j, k, l]</span>
<span class=hljs-comment ># N = [ik, jl, k, l]</span>
<span class=hljs-comment >#</span>
<span class=hljs-comment ># W * L &lt;= B</span>
<span class=hljs-comment ># U * L =  N</span>
<span class=hljs-comment ># L = U^{-1}*N</span>
<span class=hljs-comment ># (W*U^{-1}) * N &lt;= B</span>
julia&gt; Uinv = <span class=hljs-built_in >Int</span>.(inv(lu(<span class=hljs-built_in >Rational</span>.(U))))
<span class=hljs-number >4</span>×<span class=hljs-number >4</span> <span class=hljs-built_in >Matrix</span>{<span class=hljs-built_in >Int64</span>}:
 <span class=hljs-number >1</span>  <span class=hljs-number >0</span>  -<span class=hljs-number >1</span>   <span class=hljs-number >0</span>
 <span class=hljs-number >0</span>  <span class=hljs-number >1</span>   <span class=hljs-number >0</span>  -<span class=hljs-number >1</span>
 <span class=hljs-number >0</span>  <span class=hljs-number >0</span>   <span class=hljs-number >1</span>   <span class=hljs-number >0</span>
 <span class=hljs-number >0</span>  <span class=hljs-number >0</span>   <span class=hljs-number >0</span>   <span class=hljs-number >1</span>

<span class=hljs-comment ># 0 &lt;= i &lt;= I-1</span>
<span class=hljs-comment ># 0 &lt;= j &lt;= J-1</span>
<span class=hljs-comment ># 0 &lt;= k &lt;= K-1</span>
<span class=hljs-comment ># 0 &lt;= l &lt;= L-1</span>
W = [ <span class=hljs-number >1</span>  <span class=hljs-number >0</span>  <span class=hljs-number >0</span>  <span class=hljs-number >0</span>    <span class=hljs-comment >#  [ i    &lt;= [ I-1</span>
     -<span class=hljs-number >1</span>  <span class=hljs-number >0</span>  <span class=hljs-number >0</span>  <span class=hljs-number >0</span>    <span class=hljs-comment >#    j         0</span>
      <span class=hljs-number >0</span>  <span class=hljs-number >1</span>  <span class=hljs-number >0</span>  <span class=hljs-number >0</span>    <span class=hljs-comment >#    k         J-1</span>
      <span class=hljs-number >0</span> -<span class=hljs-number >1</span>  <span class=hljs-number >0</span>  <span class=hljs-number >0</span>    <span class=hljs-comment >#    l ]       0</span>
      <span class=hljs-number >0</span>  <span class=hljs-number >0</span>  <span class=hljs-number >1</span>  <span class=hljs-number >0</span>    <span class=hljs-comment >#              K-1</span>
      <span class=hljs-number >0</span>  <span class=hljs-number >0</span> -<span class=hljs-number >1</span>  <span class=hljs-number >0</span>    <span class=hljs-comment >#              0</span>
      <span class=hljs-number >0</span>  <span class=hljs-number >0</span>  <span class=hljs-number >0</span>  <span class=hljs-number >1</span>    <span class=hljs-comment >#              L-1</span>
      <span class=hljs-number >0</span>  <span class=hljs-number >0</span>  <span class=hljs-number >0</span> -<span class=hljs-number >1</span> ]  <span class=hljs-comment >#              0   ]</span>

julia&gt; W*Uinv
<span class=hljs-number >8</span>×<span class=hljs-number >4</span> <span class=hljs-built_in >Matrix</span>{<span class=hljs-built_in >Int64</span>}:
  <span class=hljs-number >1</span>   <span class=hljs-number >0</span>  -<span class=hljs-number >1</span>   <span class=hljs-number >0</span>    <span class=hljs-comment >#  [ ik   &lt;= [ I-1</span>
 -<span class=hljs-number >1</span>   <span class=hljs-number >0</span>   <span class=hljs-number >1</span>   <span class=hljs-number >0</span>    <span class=hljs-comment >#    jl        0</span>
  <span class=hljs-number >0</span>   <span class=hljs-number >1</span>   <span class=hljs-number >0</span>  -<span class=hljs-number >1</span>    <span class=hljs-comment >#    k         J-1</span>
  <span class=hljs-number >0</span>  -<span class=hljs-number >1</span>   <span class=hljs-number >0</span>   <span class=hljs-number >1</span>    <span class=hljs-comment >#    l ]       0</span>
  <span class=hljs-number >0</span>   <span class=hljs-number >0</span>   <span class=hljs-number >1</span>   <span class=hljs-number >0</span>    <span class=hljs-comment >#              K-1</span>
  <span class=hljs-number >0</span>   <span class=hljs-number >0</span>  -<span class=hljs-number >1</span>   <span class=hljs-number >0</span>    <span class=hljs-comment >#              0</span>
  <span class=hljs-number >0</span>   <span class=hljs-number >0</span>   <span class=hljs-number >0</span>   <span class=hljs-number >1</span>    <span class=hljs-comment >#              L-1</span>
  <span class=hljs-number >0</span>   <span class=hljs-number >0</span>   <span class=hljs-number >0</span>  -<span class=hljs-number >1</span> ]  <span class=hljs-comment >#              0   ]</span>

<span class=hljs-comment ># 0 &lt;= k &lt;= K-1</span>
<span class=hljs-comment ># 0 &lt;= l &lt;= L-1</span>
<span class=hljs-comment ># k &lt;= ik &lt;= I-1 + k</span>
<span class=hljs-comment ># l &lt;= jl &lt;= J-1 + l</span>
<span class=hljs-comment ># now, we want to permute the `ik` loop to the outside</span>
<span class=hljs-comment ># 0 &lt;= ik &lt;= I-1 + K-1 = I+K-2</span>
<span class=hljs-comment ># 0 &lt;= k &lt;= K-1</span>
<span class=hljs-comment ># ik - I-1 &lt;= k &lt;= ik</span>
<span class=hljs-comment ># now, we want to permute the `jl` loop to the outside</span>
<span class=hljs-comment ># 0 &lt;= jl &lt;= J-1 + L-1 = J+L-2</span>
<span class=hljs-comment ># 0 &lt;= l &lt;= L-1</span>
<span class=hljs-comment ># jl-(J-1) &lt;= l &lt;= jl</span></code></pre> <div class=page-foot > <div class="copyright bt b--moon-gray mt4 pt2"> <small class=gray > &copy; Chris Elrod, Yingbo Ma. Last modified: March 03, 2022. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </small> </div> </div> </div> </div>